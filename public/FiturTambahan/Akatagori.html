<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katagori Produk</title>    <!--line icon-->
    <link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet" />
    <!---bootstrap terbaru-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/styleProjekIni.css">
  </head>

  <body>

   <div class="wrapper">
    <!-- Navbar -->
    <aside id="sidebar">

            <div class="d-flex">
             <button class="toggle-btn" type="button">
               <i class="lni lni-grid-alt"></i>
              </button>
              <div class="sidebar-logo">
                <a href="index.html">Toko Maskot</a>
              </div>              
            </div>

            
            <ul class="sidebar-nav">
                <li class="sidebar-item">
                    <a href="index.html" class="sidebar-link">
                        <i class="lni lni-user"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="namaProduk.html" class="sidebar-link">
                        <i class="lni lni-agenda"></i>
                        <span>Produk</span>
                    </a>
                </li>
                </li>
                <li class="sidebar-item">
                    <a href="kulaan.html" class="sidebar-link">
                        <i class="lni lni-cart-full"></i>
                        <span>Kulaan</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="#" class="sidebar-link collapsed has-dropdown" data-bs-toggle="collapse"
                        data-bs-target="#multi" aria-expanded="false" aria-controls="multi">
                        <i class="lni lni-layout"></i>
                        <span>Multi Level</span>
                    </a>
                    <ul id="multi" class="sidebar-dropdown list-unstyled collapse" data-bs-parent="#sidebar">
                        <li class="sidebar-item">
                            <a href="#" class="sidebar-link collapsed" data-bs-toggle="collapse"
                                data-bs-target="#multi-two" aria-expanded="false" aria-controls="multi-two">
                                Two Links
                            </a>
                            <ul id="multi-two" class="sidebar-dropdown list-unstyled collapse">
                                <li class="sidebar-item">
                                    <a href="#" class="sidebar-link">Link 1</a>
                                </li>
                                <li class="sidebar-item">
                                    <a href="#" class="sidebar-link">Link 2</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li class="sidebar-item">
                    <a href="#" class="sidebar-link">
                        <i class="lni lni-popup"></i>
                        <span>Notification</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="#" class="sidebar-link">
                        <i class="lni lni-cog"></i>
                        <span>Setting</span>
                    </a>
                </li>
            </ul>

            <div class="sidebar-footer">
                <a href="#" class="sidebar-link">
                    <i class="lni lni-exit"></i>
                    <span>Logout</span>
                </a>
            </div>

    </aside>

    <!-- Table -->
    <div class="main p-3">
      <table class="table table-striped">
        <thead>
          <th>no</th>
          <th> Jenis Produk 
            <button id="plusbtn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal"> 
              <i class="lni lni-plus"> </i> 
            </button> 
            <input type="text" id="searchInput" placeholder="Cari produk...">  
          </th> 
          <th> <input type="text" id="filterInput" placeholder="Filter berdasarkan nama..."></th>  
          <th>Action</th>  
        </thead>
        <tbody id="tBody1"></tbody>
      </table>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
         <div id="form-container">
          <!-- Form pertama -->
          <div class="modal-body" id="form-1"> 
            <input type="text" id="id-1" size="3"">  
            <input type="text" id="nama-1" placeholder="Nama Katagori" size="15">          
            <select id="select-1" class="select-input">
              <option value="">Pilih Jenis Produk</option>
            </select>                      
           
          </div>

         </div>
              <br><br>

          <div class="modal-footer">
           <button type="button" class="btn btn-primary" id="add-nama">Tambah Nama</button>           
           <button type="button" class="btn btn-primary" id="save-nama">Save</button>          
           <button type="button" class="btn btn-success" id="update" hidden>Update</button>
          </div>
        </div>
      </div>
    </div>

    </div>
  
      
    
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
   <script src="../javaScript/scriptProjekIni.js"></script>    
   <script type="module">
        import { ref, set, child, get, push, update, remove, onValue, orderByChild, limitToLast } 
          from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";   
         import { database } from "../javaScript/koneksi.js";  
  
     const db = database;
     const dbRef = ref(db);

    const formContainer = document.getElementById("form-container");
    const plusbtn = document.getElementById("plusbtn");
    const Id1 = document.getElementById("id-1");
    const jenis1 = document.getElementById("select-1");
    const searchInput = document.getElementById('searchInput');
    const filterInput = document.getElementById('filterInput');
    const nama1 = document.getElementById("nama-1");
    const addNamaBtn = document.getElementById("add-nama");
    const saveNamaBtn = document.getElementById("save-nama");
    const updateBtn = document.getElementById("update");

    let formCount = 1; // Mulai dari form pertama

    plusbtn.addEventListener("click", () => {

      Id1.value = "";
      jenis1.innerHTML = `<option value="">Pilih Jenis Produk</option>`;
      populateSelectOptions(jenis1);
      nama1.value = "";
/*
      let i=1;
      if (formCount >= 2) {
        for (i > 1; i <= formCount; i++) {
          const formToRemove = document.getElementById(`form-${i}`);
          formContainer.removeChild(formToRemove);
          console.log("Form Count: " + formCount);
        }
      } else
      if (formCount == 1) {/*
        const newForm = document.createElement("div");
        newForm.className = "modal-body";
        newForm.id = `form-${formCount}`;
        newForm.innerHTML = ` 
          <input type="text" id="id-${formCount}" size="3" value="1">
          <input type="text" id="nama-${formCount}" placeholder="Nama Katagori" size="15">          
          <select id="select-${formCount}"><option value="">Choose an option</option> </select>
        `;
        formContainer.appendChild(newForm);
        console.log("normal");
      }
           //Ini sudah baik
      if(formCount>1){
        const formToRemove = document.getElementById(`form-${formCount--}`);
        formContainer.removeChild(formToRemove);
        console.log("Form Count: " + formCount);
      }if (formCount == 1) {
        console.log("normal");
      }*/



      addNamaBtn.hidden = false;
      saveNamaBtn.hidden = false;
      updateBtn.hidden = true;

      
    
       async function getLastNomor() {
          const snapshot = await get(child(dbRef, 'dBkatagoriBarang/'));
          const data = snapshot.val();
          if(data === null){
            Id1.value = 1;
          }else{
            const keys = Object.keys(data);
            const lastKey = keys[keys.length - 1];
            const lastNumber = parseInt(lastKey);
            Id1.value = lastNumber + 1;
          }
        
        }

         getLastNomor();        
    });

    // Ambil data untuk select list dari database
    async function populateSelectOptions(selectElement) {
      const selectRef = ref(db, "dBnamaBarang");
      const snapshot = await get(selectRef);
      if (snapshot.exists()) {
        const options = snapshot.val();
        for (const key in options) {
          const option = document.createElement("option");
          option.value = key;
          option.textContent = options[key].spesifikasiBarang;
          selectElement.appendChild(option);
        }
      }
    }
 
      // Fungsi untuk menambahkan form baru
    addNamaBtn.addEventListener("click", () => {
      formCount++;
      const Fno = formCount-1;      
      const Fni = "id-" + Fno;
      const Fni1 = Number(document.getElementById(Fni).value)+1;
      const newForm = document.createElement("div");
      newForm.className = "modal-body";
      newForm.id = `form-${formCount}`;
      newForm.innerHTML = ` 
        <input type="text" id="id-${formCount}" size="3" value="${Fni1}">          
         <select id="select-${formCount}"><option value="">Choose an option</option> </select>
        <button onclick="removeForm('${formCount}')">Hapus</button>
      `;
      formContainer.appendChild(newForm);

       // Populate select options
      const selectElement = newForm.querySelector(`#select-${formCount}`);
      populateSelectOptions(selectElement);
    });

    // Fungsi untuk menyimpan data
    saveNamaBtn.addEventListener("click", async () => {
      const dataRef = ref(db, "dBkatagoriBarang/");
      const snapshot = await get(dataRef);
      let nextId = 1;
      if (snapshot.exists()) {
        const data = snapshot.val();
        nextId = Math.max(...Object.keys(data).map(Number)) + 1;
      }

      for (let i = 1; i <= formCount; i++) {
        const form = document.getElementById(`form-${i}`);
        if (!form) continue;

        const Id = form.querySelector(`#id-${i}`).value;         
        const selectElement = form.querySelector(`#select-${i}`); // Mengambil elemen select
        const namaValue = nama1.value; // Mengambil nilai dari input
        const selectValue = selectElement.value; // Mendapatkan nilai dari elemen select
        const selectText = selectElement.options[selectElement.selectedIndex].textContent; // Mendapatkan teks dari elemen select

   
        if (!Id ||!namaValue || !selectValue) {
          alert(`Form ${i} belum lengkap!`);
          return;
        }
        
        // Simpan data ke Firebase
        const id = nextId++;
        await set(ref(db, `dBkatagoriBarang/${id}`), {
          id: Id,
          katagori: namaValue,
          spesifikasiBarang: selectText,
          
        });

        alert(`Inputan form ${i} disimpan.`);
         
      }
      location.reload();
    }
  );

    
    // Fungsi untuk menghapus form
    window.removeForm = (formId) => {
      if (formId !== "1") {
        const formToRemove = document.getElementById(`form-${formId}`);
        formContainer.removeChild(formToRemove);
      }
    };

    function getData() {
          const starCountRef = ref(db, 'dBkatagoriBarang/');

          onValue(starCountRef, (snapshot) => {
            tBody1.innerHTML = "";
            const data = snapshot.val();

           if(data){
            Object.entries(data).forEach(([key, value]) => {
             if (value) {
              const row = `
                <tr>
                  <td>${key}</td>
                  <td>${value.katagori}</td>
                  <td>${value.spesifikasiBarang}</td>
                  <td><button id="btnUpdate" class="btn btn-secondary" data-no="${key}" data-katagori="${value.katagori}" data-spesifikasi="${value.spesifikasiBarang}"
                        data-bs-toggle="modal" data-bs-target="#exampleModal" >Update</button>
                      <button id="btnHapus" class = "btn btn-danger" data-no="${key}">Hapus</button>
                  </td>
                </tr>
              `;
              tBody1.insertAdjacentHTML('beforeend', row);
             }
            });
           }    

          
          

           const btnEdit = document.querySelectorAll("#btnUpdate");
           const btnHapus = document.querySelectorAll("#btnHapus");

           btnEdit.forEach((item) => {
            item.addEventListener("click", async function () {
              let no = item.getAttribute("data-no");
              let katagori = item.getAttribute("data-katagori");
              let spesifikasi = item.getAttribute("data-spesifikasi");
              Id1.value = no;
              const snapshot = await get(ref(db, "dBnamaBarang"));
              if (snapshot.exists()) {
                const options = snapshot.val();
                jenis1.innerHTML = Object.entries(options)
                    .map(([key, value]) => {
                        const isSelected = spesifikasi === value.spesifikasiBarang ? "selected" : "";
                        return `<option value="${key}" ${isSelected}>${value.spesifikasiBarang}</option>`;
                    })
                    .join('');
              } else {
                console.warn("No select list data found.");
              }
              
              nama1.value = katagori;                  
               addNamaBtn.hidden = true;
              saveNamaBtn.hidden = true;             
              updateBtn.hidden = false;
            });
           });

           btnHapus.forEach((item) => {
            item.addEventListener("click", function () {
              let no = item.getAttribute("data-no");
              remove(ref(db, 'dBkatagoriBarang/' + no))
              .then(() => {
                alert("Data Terhapus");
                location.reload();
              })
              .catch((error) => {
                alert("Data Gagal Terhapus" + error);
              });
            });
           });
           });
                 
        }

         
      
        // Populate select options for the first form
        populateSelectOptions(jenis1);
   
       function shouldDisplayItem(item) {
        const searchValue = searchInput.value.toLowerCase();
        const filterValue = filterInput.value.toLowerCase();

        const matchesSearch = item.jenisBarang.toLowerCase().includes(searchValue);
        const matchesFilter = !filterValue || item.nama.toLowerCase().includes(filterValue);

        return matchesSearch && matchesFilter;
       }
      // Event listener untuk input pencarian dan filter
      searchInput.addEventListener('input', getData);
      filterInput.addEventListener('input', getData);
      
      getData(); 

        updateBtn.addEventListener('click', function() {
          if(Id1.value == "" || jenis1.value == "" || nama1.value == ""){
            alert("Data Tidak Boleh Kosong");
          }else{
             const selectText = jenis1.options[jenis1.selectedIndex].textContent;
              //const selectValue = selectElement.value; // Mendapatkan nilai dari elemen select
              //const selectText = selectElement.options[selectElement.selectedIndex].textContent; // Mendapatkan teks dari elemen select
            update(ref(db, 'dBkatagoriBarang/' + Id1.value), {
              id: Id1.value,
              spesifikasiBarang: selectText,
              katagori: nama1.value
            })
            .then(() => {
              alert("Data Terupdate");
             const modal = document.getElementById('exampleModal');
              const modalBS = bootstrap.Modal.getInstance(modal);
              modalBS.hide();
              
              
            })
            .catch((error) => {
              alert("Data Gagal Terupdate" + error);
            });
          }
        });

   </script>
  </body>
</html>